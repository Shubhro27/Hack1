Check the slides from TechM, placed in C:\Users\Shubhro\Desktop\Learnings\UPX\my created notes

Check material on : https://www.tutorialspoint.com/apache_pig/

also on, https://pig.apache.org/docs/r0.7.0/piglatin_ref2.html

cheatsheet: https://www.qubole.com/resources/pig-function-cheat-sheet/

Pig and DB: https://stackoverflow.com/questions/9271996/pig-latin-script-for-database-access

Loading DB into Hadoop: https://www.safaribooksonline.com/blog/2013/05/02/importing-data-from-relational-databases-into-hadoop/


-----------------------------------------------------------
Flatten operator:
un-nests tuples as well as bags.

For tuples, flatten substitutes the fields of a tuple in place of the tuple. For example, consider a relation that has a tuple of the form (a, (b, c)). The expression GENERATE $0, flatten($1), will cause that tuple to become (a, b, c).

When we un-nest a bag, we create new tuples. If we have a relation that is made up of tuples of the form ({(b,c),(d,e)}) and we apply GENERATE flatten($0), we end up with two tuples (b,c) and (d,e). When we remove a level of nesting in a bag, sometimes we cause a cross product to happen. For example, consider a relation that has a tuple of the form (a, {(b,c), (d,e)}), commonly produced by the GROUP operator. If we apply the expression GENERATE $0, flatten($1) to this tuple, we will create new tuples: (a, b, c) and (a, d, e).

examples,
cat,Shubhro   
dog,Shubhro     
cat,Shree    
fish,Neelabh    
fish,Shree    
dog,Shree     
dog,Nimesh     
cat,Arnav     
dog,Manish     
bird,Arnav    
tortoise,Nimesh
bird,Shubhro    
cow,Shree    

grunt> owner_list = LOAD 'animal_owner_data.txt' USING PigStorage(',') AS (pet:chararray,owner:chararray);
(cat,Shubhro   )
(dog,Shubhro     )
(cat,Shree    )
(fish,Neelabh    )
(fish,Shree    )
(dog,Shree     )
(dog,Nimesh     )
(cat,Arnav     )
(dog,Manish     )
(bird,Arnav    )
(tortoise,Nimesh)
(bird,Shubhro    )
(cow,Shree )

grunt> group_by_pet = GROUP owner_list by pet;
(cat,{(cat,Arnav     ),(cat,Shree    ),(cat,Shubhro   )})
(cow,{(cow,Shree )})
(dog,{(dog,Manish     ),(dog,Shree     ),(dog,Shubhro     ),(dog,Nimesh     )})
(bird,{(bird,Arnav    ),(bird,Shubhro    )})
(fish,{(fish,Shree    ),(fish,Neelabh    )})
(tortoise,{(tortoise,Nimesh)})

grunt> try1 = FOREACH group_by_pet GENERATE FLATTEN($1);
(cat,Arnav     )
(cat,Shree    )
(cat,Shubhro   )
(cow,Shree )
(dog,Manish     )
(dog,Shree     )
(dog,Shubhro     )
(dog,Nimesh     )
(bird,Arnav    )
(bird,Shubhro    )
(fish,Shree    )
(fish,Neelabh    )
(tortoise,Nimesh)

grunt> try2 = FOREACH group_by_pet GENERATE FLATTEN($0);
(cat)
(cow)
(dog)
(bird)
(fish)
(tortoise)

grunt> try3 = FOREACH group_by_pet GENERATE group,FLATTEN($1);
(cat,cat,Arnav     )
(cat,cat,Shree    )
(cat,cat,Shubhro   )
(cow,cow,Shree )
(dog,dog,Manish     )
(dog,dog,Shree     )
(dog,dog,Shubhro     )
(dog,dog,Nimesh     )
(bird,bird,Arnav    )
(bird,bird,Shubhro    )
(fish,fish,Shree    )
(fish,fish,Neelabh    )
(tortoise,tortoise,Nimesh)

grunt> try4 = FOREACH group_by_pet GENERATE FLATTEN($1),group;
(cat,Arnav     ,cat)
(cat,Shree    ,cat)
(cat,Shubhro   ,cat)
(cow,Shree ,cow)
(dog,Manish     ,dog)
(dog,Shree     ,dog)
(dog,Shubhro     ,dog)
(dog,Nimesh     ,dog)
(bird,Arnav    ,bird)
(bird,Shubhro    ,bird)
(fish,Shree    ,fish)
(fish,Neelabh    ,fish)
(tortoise,Nimesh,tortoise)

grunt> try5 = FOREACH group_by_pet GENERATE FLATTEN(owner_list.owner),group;
(Arnav     ,cat)
(Shree    ,cat)
(Shubhro   ,cat)
(Shree ,cow)
(Manish     ,dog)
(Shree     ,dog)
(Shubhro     ,dog)
(Nimesh     ,dog)
(Arnav    ,bird)
(Shubhro    ,bird)
(Shree    ,fish)
(Neelabh    ,fish)
(Nimesh,tortoise)



--------------------------------------
Case Study on Indian Premier League T20
The IPL dataset contains cricket match played between Gujarat Lions Vs Sunrisers Hyderabad on 27/5/16 in Delhi.
Understanding Data
The data format is comma separated values. The top 19 rows contain data on the other details like participating team, venue, city and results of the match. It contains 12 columns made up of following: Ball, team batting, ball overs, bating team, batsmen on strike, Second batsmen, bowler, runs scored, extras, result, player who is out.


Load the Data in HDFS and display it
T20_data = LOAD 'pig_T20_data.xls' USING PigStorage(',');
DUMP T20_data

#SPLIT T20_data INTO T20_info IF ($0 == 'info'),T20_score IF ($0 == 'ball');

How many runs did David Warner score in the match?
#T20_Hyd_david = FILTER T20_score BY ($4 matches 'DA Warner');
#T20_david_grp = GROUP T20_Hyd_david BY $4;
#T20_david_runs = FOREACH T20_Hyd_david GENERATE $4 as name:chararray, $7 as runs:int;
#DESCRIBE T20_david_runs;
#T20_david_grp = GROUP T20_david_runs BY T20_david_runs.name;
#T20_david_total = FOREACH T20_david_runs GENERATE SUM(runs); 

#T20_hyd_innings = FILTER T20_score BY ($1 matches '2');
#T20_hyd_score = FOREACH T20_hyd_innings GENERATE $4 as batsman:chararray, $7 as runs:int;
#T20_hyd_grp1 = GROUP T20_hyd_score BY T20_hyd_score.batsman;

T20_data = LOAD 'pig_T20_data.xls' USING PigStorage(',') AS (ball:chararray, team:int, overs: float, teamBating:chararray, batsmen1:chararray, batsmen2:chararray, bowler:chararray,runs:int, other:int, result: chararray, playerOut:chararray);
#T20_david_innings = FILTER T20_data BY ($4 matches 'DA Warner');
#T20_david_runs = group T20_david_innings BY T20_david_innings.batsmen1,T20_david_innings.runs as score;
T20_david_runs = FOREACH (GROUP T20_david_innings BY T20_david_innings.batsmen1) GENERATE SUM(T20_david_innings.runs);

T20_david_run1 = FOREACH (GROUP T20_david_innings BY 'DA WARNER') GENERATE SUM(T20_david_innings.runs);

How many wickets did DJ Bravo take in match?
T20_data = LOAD 'pig_T20_data.xls' USING PigStorage(',') AS (ball:chararray, team:int, overs: float, teamBating:chararray, batsmen1:chararray, batsmen2:chararray, bowler:chararray,runs:int, other:int, result: chararray, playerOut:chararray);
#T20_bravo_list = FILTER T20_data BY (T20_data.bowler matches 'DJ Bravo') and (T20_data.playerOut is NOT NULL);
#T20_bravo_list = FILTER T20_data BY ($6 matches 'DJ Bravo');
T20_bravo_grp = GROUP T20_bravo_list2 BY bowler;
T20_bravo_list2 = FILTER T20_data BY (bowler matches 'DJ Bravo') AND (playerOut is NOT NULL);
T20_bravo_wickets = FOREACH T20_bravo_grp GENERATE group,COUNT($1);

How many runs did Praveen Kumar concede in the match?
T20_data = LOAD 'pig_T20_data.xls' USING PigStorage(',') AS (ball:chararray, team:int, overs: float, teamBating:chararray, batsmen1:chararray, batsmen2:chararray, bowler:chararray,runs:int, other:int, result: chararray, playerOut:chararray);
T20_Kumar = FILTER T20_data BY (bowler matches 'B Kumar') AND (runs > 0);
T20_Kumar_grp = GROUP T20_Kumar BY bowler;
T20_Kumar_wickets = FOREACH T20_Kumar_grp GENERATE SUM(T20_Kumar.runs);

How many extras were bowled in the match?
T20_extras = FILTER T20_data BY (other > 0);
T20_extras_grp = GROUP T20_extras ALL;
T20_extras_cnt = FOREACH T20_extras_grp GENERATE COUNT($1);

What is the final score of Gujarat Lions?
GL_innings = FILTER T20_data BY teamBating == 'Gujarat Lions' AND runs > 0;
GL_inning_grp = GROUP GL_innings BY team;
#GL_inning_run = FOREACH GL_inning_grp GENERATE SUM(GL_inning_grp.runs);
GL_inning_run = FOREACH GL_inning_grp GENERATE SUM(GL_innings.runs);

How many balls were faced by Bb McCullum in the match?
BB_life = FILTER T20_data BY (batsmen1 == 'BB McCullum');
BB_life_grp = GROUP BB_life ALL;
BB_balls_faced = FOREACH BB_life_grp GENERATE COUNT($1);

Find the players who were run out in the match?
T20_data = LOAD 'pig_T20_data.xls' USING PigStorage(',') AS (ball:chararray, team:int, overs: float, teamBating:chararray, batsmen1:chararray, batsmen2:chararray, bowler:chararray,runs:int, other:int, result: chararray, playerOut:chararray);
T20_run_out = FILTER T20_data BY result matches '^run.+';
T20_players_run_out = FOREACH T20_run_out GENERATE batsmen1;

Store the players who were run out in the match in HDFS
STORE T20_run_out INTO 'hdfs://ip-172-31-53-48.ec2.internal:8020/user/shubhro2705854012/pig_T20/' USING PigStorage(',');

-------------------

/home/shubhro2705854012/pigFiles/pig_animal_list:
cat     doug    5
dog     bosco   10
cat     mili    1
fish    chilli  2
fish    appu    2.5
dog     caeser  5.5
dog     dolby   14
cat     zini    6
dog     lalli   2
bird    tweety  4
tortoise        raftar  40
bird    tia     1.5
cow     amba    12
dog     lallan  12
dog     gabby   6.5
dog     moti    17
-------------------------------------------------
pig_udf1.py

from pig_util import outputSchema
@outputSchema('hello_word:chararray')
def hi_world():    
 return "hello world"
-------------------------------------------------
REGISTER './pig_udf1.py' using jython as shubhro_udfs;
register './udfs.py' using org.apache.pig.scripting.jython.JythonScriptEngine as shubhro_udfs;
-------------------------------------------------
animal_list = LOAD '/home/shubhro2705854012/pigFiles/pig_animal_list' AS (type:chararray,name:chararray,age:double);
animal_item = FOREACH animal_list GENERATE name,shubhro_udfs.hi_world();

O/p:
(doug,hello world)(bosco,hello world)(mili,hello world)(chilli,hello world)(appu,hello world)(caeser,hello world)(dolby,hello world)(zini,hello world)(lalli,hello world)(tweety,hello world)(raftar,hello world)(tia,hello world)(amba,hello world)(lallan,hello world)(gabby,hello world)(moti,hello world)
-------------------------------------------------
I make a change in pig_udf1.py,
a) checking if I need to register again.
grunt> animal_list = LOAD '/home/shubhro2705854012/pigFiles/pig_animal_list' AS (type:chararray,name:chararray,age:double);
grunt> animal_item = FOREACH animal_list GENERATE name,shubhro_udfs.hi_world();
2017-12-20 08:26:47,019 [main] ERROR org.apache.pig.tools.grunt.Grunt - ERROR 1070: Could not resolve shubhro_udfs.hi_world using imports: [, java.lang., org.apache.pig.builtin., org.apache.pig.impl.builtin.]
Details at logfile: /home/shubhro2705854012/pig_udf/pig_1513758390480.loggrunt> 
REGISTER './pig_udf1.py' using jython as shubhro_udfs;2017-12-20 08:27:13,291 [main] 
INFO  org.apache.pig.scripting.jython.JythonScriptEngine - created tmp python.cachedir=/tmp/pig_jython_55196379345788731862017-12-20 08:27:14,338 [
main] WARN  org.apache.pig.scripting.jython.JythonScriptEngine - pig.cmd.args.remainders is empty. 
This is not expected unless on testing.2017-12-20 08:27:14,373 [main] 
INFO  org.apache.pig.scripting.jython.JythonScriptEngine - Register scripting UDF: shubhro_udfs.hi_world

b) I register again.
grunt> REGISTER './pig_udf1.py' using jython as shubhro_udfs;
grunt> animal_item = FOREACH animal_list GENERATE shubhro_udfs.hi_world(),name;

o/p:
(hello,doug)(hello,bosco)(hello,mili)(hello,chilli)(hello,appu)(hello,caeser)(hello,dolby)(hello,zini)(hello,lalli)(hello,tweety)(hello,raftar)(hello,tia)(hello,amba)(hello,lallan)(hello,gabby)(hello,moti)

conclusion: we will need to REGISTER everytime, we are out of GRUNT Shell.
NOTE:  Jython is an implementation of Python that runs on the Java Virtual Machine (JVM). 
	   Most of the time this is not an issue as Jython strives to implement all of the same features of CPython 
	   but there are some libraries that it doesn't allow. For example you can't use numpy from Jython.
------------------------------------------------------
Update: pig_udf1.py
@outputSchema('hello_word:chararray')
def hi_world():    
	return "hello"

@outputSchema('some_bag:bag{t:(field_1:chararray, field_2:int)}')
def bag_udf():    
 return [        
			('hi',1000),        
			('there',2000),        
			('bill',0)    
		]
		
#and here is a map@outputSchema('something_nice:map[]')
def my_map_maker():    
	return {"a":"b", "c":"d", "e":"f"}

grunt> REGISTER './pig_udf1.py' using jython as shubhro_udfs;
grunt> animal_list = LOAD '/home/shubhro2705854012/pigFiles/pig_animal_list' AS (type:chararray,name:chararray,age:double);
grunt> animal_item = FOREACH animal_list GENERATE name,shubhro_udfs.my_map_maker();	

-------------------------------------------------------
passing arguments to UDF:
def deal_string1(s1,d1):    
	return s1 + " age is " + d1
	
def deal_string2(s1,s2):    
	return s1 + " " + s2
	
REGISTER './pig_udf1.py' using jython as shubhro_udfs;
animal_list = LOAD '/home/shubhro2705854012/pigFiles/pig_animal_list' AS (type:chararray,name:chararray,age:double);
animal_item1 = FOREACH animal_list GENERATE shubhro_udfs.deal_string1(name,age);
o/p:
grunt> animal_item1 = FOREACH animal_list GENERATE shubhro_udfs.deal_string1(name,age);2017-12-20 08:58:42,486 [main] INFO  org.apache.pig.scripting.jython.JythonFunction - No schema defined for function 'deal_string1' in /home/shubhro2705854012/pig_udf/pig_udf1.py
(doug age is 5.0)(bosco age is 10.0)(mili age is 1.0)(chilli age is 2.0)(appu age is 2.5)(caeser age is 5.5)(dolby age is 14.0)(zini age is 6.0)(lalli age is 2.0)(tweety age is 4.0)(raftar age is 40.0)(tia age is 1.5)(amba age is 12.0)(lallan age is 12.0)(gabby age is 6.5)(moti age is 17.0)

animal_item2 = FOREACH animal_list GENERATE shubhro_udfs.deal_string1(name,type);
o/p:
(doug age is cat)(bosco age is dog)(mili age is cat)(chilli age is fish)(appu age is fish)(caeser age is dog)(dolby age is dog)(zini age is cat)(lalli age is dog)(tweety age is bird)(raftar age is tortoise)(tia age is bird)(amba age is cow)(lallan age is dog)(gabby age is dog)(moti age is dog)
------------------------------------------------------
NOTE: Pig doesn't really allow for Python Filter UDFs
	so, in order to filter we can use code like,
	user_messages = LOAD 'user_twits' AS (name:chararray, message:chararray);
	--add a field that says whether it is naughty (1) or not (0)
	messages_with_rudeness = FOREACH user_messages GENERATE name,message,contains_naughty_words(message) as naughty;     
	--then filter by the naughty field
	filtered_messages = FILTER messages_with_rudeness by (naughty==1);    
	-- and finally strip away the naughty field                  
	rude_messages = FOREACH filtered_messages GENERATE name,message;  
	
--------------------------------------------------------
Python streaming UDFs

#! /usr/bin/env python
#!/usr/bin/python
import sys
import string

for line in sys.stdin:
    if len(line) == 0: continue   
    l = line.split()    #split the line by whitespace
    for i,s in enumerate(l):
        print "{key}\t{value}\n".format(key=i,value=s)
		
		
		
pig_animal_owner_data.txt
REGISTER './simple_stream.py' using jython as shubhro_stream_udfs;
owner_list = LOAD '/home/shubhro2705854012/pigFiles/pig_animal_owner_data.txt' AS (type:chararray,owner_name:chararray);

#DEFINE stream_alias 'simple_stream.py' SHIP('simple_stream.py');
DEFINE shub_stream_alias 'simple_stream.py' SHIP('/home/shubhro2705854012/pig_udf/simple_stream.py');
DEFINE CMD 'simple_stream.py' SHIP('/home/shubhro2705854012/pig_udf/simple_stream.py');
#user_messages = LOAD 'user_twits' AS (name:chararray, message:chararray);
owner_list = LOAD '/home/shubhro2705854012/pigFiles/pig_animal_owner_data.txt' AS (type:chararray,owner_name:chararray);
#just_messages = FOREACH user_messages generate message;
owner_name = FOREACH owner_list GENERATE owner_name;
#streamed = STREAM just_messages THROUGH stream_alias;
stream_name = STREAM owner_name THROUGH shub_stream_alias;
DUMP streamed;

grunt> DEFINE shub_stream_alias 'simple_stream.py' SHIP('simple_stream.py');
2017-12-20 10:07:41,023 [main] ERROR org.apache.pig.tools.grunt.Grunt - 
ERROR 1200: <line 1, column 25>  Syntax error, unexpected symbol at or near ''simple_stream.py''Details at 
logfile: /home/shubhro2705854012/pig_udf/pig_1513764010522.log

-----------
Hi,
I have a question from Python streaming UDF's.

I have written a python UDF (simple_stream.py) as,
#!/usr/bin/python
import sys
import string

for line in sys.stdin:
    if len(line) == 0: continue   
    l = line.split()    #split the line by whitespace
    for i,s in enumerate(l):
        print "{key}\t{value}\n".format(key=i,value=s)  
		
I login to GRUNT shell,
grunt> DEFINE shub_stream_alias 'simple_stream.py' SHIP('simple_stream.py');

I get the error,
2017-12-20 10:07:41,023 [main] ERROR org.apache.pig.tools.grunt.Grunt - 
ERROR 1200: <line 1, column 25>  Syntax error, unexpected symbol at or near ''simple_stream.py''Details at 
logfile: /home/shubhro2705854012/pig_udf/pig_1513764010522.log

Could you please help me with the error reason?

NOTE: I have tried giving the complete path, removing single quotes etc,removing brackets etc but the error remains the same.
I have also tried,
grunt> DEFINE shub_stream_alias simple_stream.py SHIP('simple_stream.py');
2017-12-20 10:42:38,984 [main] ERROR org.apache.pig.tools.grunt.Grunt - ERROR 1200: <line 1, column 42>  
Syntax error, unexpected symbol at or near 'SHIP'Details at logfile: /home/shubhro2705854012/pig_udf/pig_1513765148713.log


----------------------------------------------------------------------
WordCount using PIG:
lines = LOAD 'word_cnt.txt' USING TextLoader() AS (line:chararray);
words = FOREACH lines GENERATE FLATTEN(TOKENIZE(line)) as word;
grouped = GROUP words BY word;
wordcount = FOREACH grouped GENERATE group, COUNT(words);
DUMP wordcount;

